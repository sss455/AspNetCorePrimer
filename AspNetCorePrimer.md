## 目次
* 第1章 ASP\.NET Core MVCの概要
* 第2章 ASP\.NET Core MVCプロジェクト
* 第3章 スキャフォールディングの利用
* 第4章 Modelの活用
* 第5章 Viewの活用
* 第6章 Controllerの活用
* 第7章 List-Detailの関係
* 第8章 複数Viewの活用
* 第9章 Web API
* 第10章 状態管理
* 第11章 ルーティング
* 第12章 認証
* 第13章 シングルページアプリケーション（SPA）
* 第14章 Azureへデプロイ
* 付録A マルチ環境ともう1つのASP\.NET Coreアプリ

<hr>

<br><br>

### 第3章 スキャフォールディングの利用
・データベースにある既存のテーブルに対して検索や更新を行うためのViewとControllerを一気に作成する機能。

**[手順の流れ]**
　(1) 新しいプロジェクトを作成する
　(2) データベースユーザーを作成
　(3) データベースを作成する
　(4) Personテーブルを作成する
　(5) Personテーブルのデータを作成する
　(6) NuGetパッケージを追加する
　(7) Modelクラスを自動作成する
　(8) Program.cs／appsetting.jsonを修正する
　(9) スキャフォールディングを実行する（View／Controllerの自動生成）
　(10) 動作確認


<hr>

**【具体的な手順】**


**(1) 新しいプロジェクトを作成する**
　　テンプレート　：「ASP.NET Core Web アプリ（Model-View-Controller）」
　　プロジェクト名：「SampleMvc」


**(2) データベースユーザーを作成**
```
※PostgreSQLの場合
> createuser --interactive mvcuser -U postgres
新しいロールをスーパーユーザーにしますか？ (y/n) n
新しいロールに対してデータベースを作成する権限を与えますか？ (y/n) n
新しいロールに対して別のロールを作成する権限を与えますか？ (y/n) n
パスワード:
```


**(3) データベースを作成する**
```
※PostgreSQLの場合
> createdb -O mvcuser mvcdb -U postgres
パスワード:
```
<font color="blue">-Oオプション</font>を使い、データベースの所有者としてmvcuserを指定する。

**・データベースの作成確認**
```
> psql -l -U postgres
ユーザー postgres のパスワード:
                                                                        データベース一覧
      名前       |  所有者  | エンコーディング | ロケールプロバイダー |      照合順序      | Ctype(変換演算子)  | ロケール | ICUルール: |     アクセス権限
-----------------+----------+------------------+----------------------+--------------------+--------------------+----------+------------+-----------------------
 mvcdb           | mvcuser  | UTF8             | libc                 | Japanese_Japan.932 | Japanese_Japan.932 |          |            |
 pgadmin         | postgres | UTF8             | libc                 | Japanese_Japan.932 | Japanese_Japan.932 |          |            |
 postgres        | postgres | UTF8             | libc                 | Japanese_Japan.932 | Japanese_Japan.932 |          |            |
 template0       | postgres | UTF8             | libc                 | Japanese_Japan.932 | Japanese_Japan.932 |          |            | =c/postgres          +
                 |          |                  |                      |                    |                    |          |            | postgres=CTc/postgres
 template1       | postgres | UTF8             | libc                 | Japanese_Japan.932 | Japanese_Japan.932 |          |            | =c/postgres          +
                 |          |                  |                      |                    |                    |          |            | postgres=CTc/postgres
 test_tablespace | postgres | UTF8             | libc                 | Japanese_Japan.932 | Japanese_Japan.932 |          |            |
(6 行)
```

**・ロールの追加**
~~# CREATE ROLE mvcuser WITH PASSWORD 'mvcuser';~~
~~# ALTER ROLE mvcuser LOGIN;~~
```
> psql -U postgres
ユーザー postgres のパスワード:

psql (18.1)
"help"でヘルプを表示します。

postgres=# ALTER ROLE mvcuser WITH PASSWORD 'mvcuser';
```


**(4) Personテーブルを作成する**
```sql
-- ■ SQLServerの場合
CREATE TABLE Person (
    id   int         IDENTITY(1, 1) NOT NULL,
    name varchar(50) NOT NULL,
    age  int         NOT NULL,
  CONSTRAINT PK_person1 PRIMARY KEY CLUSTERED
  (
      id ASC
  )
);

-- ■ PostgreSQLの場合
CREATE TABLE person (
    id   integer     GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    name varchar(50) NOT NULL,
    age  integer     NOT NULL,
    CONSTRAINT pk_person1 PRIMARY KEY (id)
);
```


**(5) Personテーブルのデータを作成する**
```sql
INSERT INTO Person(name, age) VALUES('matsuda', 50);
INSERT INTO Person(name, age) VALUES('yamada',  40);
INSERT INTO Person(name, age) VALUES('sato',    30);
```


**(6) NuGetパッケージを追加する**
<u>■ SQLServerの場合</u>
 ・Microsoft.EntityFrameworkCore.Design
 ・Microsoft.EntityFrameworkCore.SqlServer
 ・Microsoft.EntityFrameworkCore.Tools

<u>■ PostgreSQLの場合</u>
 ・Microsoft.EntityFrameworkCore.Design
 ・Microsoft.EntityFrameworkCore.SqlServer
 ・Microsoft.EntityFrameworkCore.Tools
 ・Microsoft.VisualStudio.Web.CodeGeneration.Design
 ・Npgsql.EntityFrameworkCore.PostgreSQL
※「Microsoft.EntityFrameworkCore.SqlServer」はスキャフォールディングで必要になる場合があるとのこと。


**(7) Modelクラスを自動作成する**
> **dotnet ef コマンド**　<font color="red">※SQLServerの場合</font>
> ```sh
> dotnet ef dbcontext scaffold {接続文字列} Microsoft.EntityFrameworkCore.> SqlServer -o {出力フォルダー}
> ```
> 
> **(例)**
> ```sh
> dotnet ef dbcontext scaffold "Server=.;Database=mvcdb;Trusted_Connection=True;TrustServerCertificate=Yes" Microsoft.EntityFrameworkCore.SqlServer -o Models
> ```

> **dotnet ef コマンド**　<font color="red">※PostgreSQLの場合</font>
> ```sh
> > dotnet ef dbcontext scaffold "Server=localhost; Port=5432; Database=mvcdb; Username=mvcuser; Password=mvcuser" Npgsql.EntityFrameworkCore.PostgreSQL -o Models
> Build started...
> Build succeeded.
> To protect potentially sensitive information in your connection string, you should move it out of source code. 
> You can avoid scaffolding the connection string by using the Name= syntax to read it from configuration - see https://go.microsoft.com/fwlink/?linkid=2131148. 
> For more guidance on storing connection strings, see https://go.microsoft.com/fwlink/?LinkId=723263.
> 　↓
> (訳)
> 接続文字列内の機密性の高い情報を保護するため、ソースコードから移動させる必要があります。
> Name=構文を使用して設定から読み込むことで、接続文字列のスケルトン生成を回避できます。
> 詳細は https://go.microsoft.com/fwlink/?linkid=2131148 を参照してください。
> 接続文字列の保存に関する詳細なガイダンスについては、https://go.microsoft.com/fwlink/?LinkId=723263 を参照してください。
> 　↓
> > dotnet ef dbcontext scaffold "Name=MvcdbContext" Npgsql.EntityFrameworkCore.PostgreSQL -o Models
> Build started...
> Build succeeded.
> ```


**(8) Program.cs／appsetting.jsonを修正する**
> **Program.cs**
> ```cs
> // ■ SQLServerの場合
> var builder = WebApplication.CreateBuilder(args);
> // Add services to the container.
> builder.Services.AddControllersWithViews();
> builder.Services.AddDbContext<MvcdbContext>(options =>
>     options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")));
> ```
> ```cs
> // ■ PostgreSQLの場合
> var builder = WebApplication.CreateBuilder(args);
> // Add services to the container.
> builder.Services.AddControllersWithViews();
> builder.Services.AddDbContext<MvcdbContext>(options =>
>     // ※Postgresqlの場合は、UseNpgsqlメソッドを使う
>     options.UseNpgsql(builder.Configuration.GetConnectionString("MvcdbContext")));
> ```

> **appsetting.json**
> ```json
> ■ SQLServerの場合
>   "ConnectionStrings": {
>     "DefaultConnection": "Server=.; Database=mvcdb; Trusted_Connection=True; > TrustServerCertificate=Yes"
>   },
> ```
> ```json
> ■ PostgreSQLの場合
>   "ConnectionStrings": {
>     "MvcdbContext": "Server=localhost; Port=5432; Database=mvcdb; Username=mvcuser; > Password=mvcuser"
>   },
> ```

**(9) スキャフォールディングを実行する（View／Controllerの自動生成）**
**(10) 動作確認**

<br>
<hr>
<br>


### 第4章 Modelの活用

ASP\.NET Core MVCアプリケーションにおけるデータベースへアクセスする2つの方法。
1. データベースからModelを作る方法（<font color="red">データベースファースト</font>）
2. Modelクラスのコードからデータベースを作成する方法（<font color="red">コードファースト</font>）

**[手順の流れ]**
　(1) DBに作成したテーブルにアクセスするModelクラスを、コマンドラインを使って作成（dotnet ef）
　(2) 接続情報をappsettings.jsに追い出す
　(3) スキャフォールディング機能を実行
　(4) 動作確認
 [データベースの変更を反映]
　(5) 
　(6) 
　(7) 
　(8) 


第3章の手順と同じ。


`Usage: dotnet ef dbcontext scaffold [arguments] [options]`

```
Arguments:
  <CONNECTION>  The connection string to the database.
  <PROVIDER>    The provider to use. (E.g. Microsoft.EntityFrameworkCore.SqlServer)

Options:
  -d|--data-annotations                  Use attributes to configure the model (where possible). If omitted, only the fluent API is used.
  -c|--context <NAME>                    The name of the DbContext. Defaults to the database name.
  --context-dir <PATH>                   The directory to put the DbContext file in. Paths are relative to the project directory.
  -f|--force                             Overwrite existing files.
  -o|--output-dir <PATH>                 The directory to put files in. Paths are relative to the project directory.
  --schema <SCHEMA_NAME>...              The schemas of tables and views to generate entity types for. All tables and views in the schemas will be included in the model, even if they are not explicitly included with the --table parameter.
  -t|--table <TABLE_NAME>...             The tables and views to generate entity types for. Tables or views in a specific schema can be included using the 'schema.table' or 'schema.view' format.
  --use-database-names                   Use table, view, sequence, and column names directly from the database.
  --json                                 Show JSON output. Use with --prefix-output to parse programmatically.
  -n|--namespace <NAMESPACE>             The namespace to use. Matches the directory by default.
  --context-namespace <NAMESPACE>        The namespace of the DbContext class. Matches the directory by default.
  --no-onconfiguring                     Don't generate DbContext.OnConfiguring.
  --no-pluralize                         Don't use the pluralizer.
  -p|--project <PROJECT>                 The project to use. Defaults to the current working directory.
  -s|--startup-project <PROJECT>         The startup project to use. Defaults to the current working directory.
  --framework <FRAMEWORK>                The target framework. Defaults to the first one in the project.
  --configuration <CONFIGURATION>        The configuration to use.
  --runtime <RUNTIME_IDENTIFIER>         The runtime to use.
  --msbuildprojectextensionspath <PATH>  Obsolete
  --no-build                             Don't build the project. Intended to be used when the build is up-to-date.
  -h|--help                              Show help information
  -v|--verbose                           Show verbose output.
  --no-color                             Don't colorize output.
  --prefix-output                        Prefix output with level.
  ```


p.97～

```sql
-- ■SQL Serverの場合
CREATE TABLE Person (
	id   int          INDENTITY(1, 1) NOT NULL,
	name nvarchar(50) NOT NULL,
	age  int          NOT NULL,
  CONSTRAINT PK_People PRIMARY KEY CLUSTERD
  (
	  id ASC
  ) WITH (
	  PAD_INDEX              = OFF,
	  STATISTICS_NORECOMPUTE = OFF,
	  IGNORE_DUP_KEY         = OFF,
	  ALLOW_ROW_LOCKS        = ON,
	  ALLOW_PAGE_LOCKS       = ON
  ) ON PRIMARY;

ALTER TABLE Person 
  WITH CHECK 
  ADD CONSTRAINT FK_Person_Address 
  FOREIGN KEY(address_id) 
  REFERENCES Address (id);

ALTER TABLE Person 
  CHECK CONSTRAINT FK_Person_Address;
```

```sql
-- ■PostgreSQLの場合
CREATE TABLE Address (
    id   integer     GENERATED ALWAYS AS IDENTITY,
    name varchar(10) NOT NULL,
  CONSTRAINT pk_address PRIMARY KEY (id)
);

CREATE TABLE Person (
    id          integer     GENERATED ALWAYS AS IDENTITY,
    name        varchar(50) NOT NULL,
    age         integer     NOT NULL,
    address_id  integer     NOT NULL,
    CONSTRAINT pk_people PRIMARY KEY (id)
);

ALTER TABLE Person
  ADD CONSTRAINT fk_person_address
  FOREIGN KEY (address_id)
  REFERENCES Address (id);
```


**都道府県のデータを挿入**
```sql
-- ■Addressテーブルへデータを挿入するクエリ
INSERT INTO Address(name) VALUES('北海道');
INSERT INTO Address(name) VALUES('青森県');
INSERT INTO Address(name) VALUES('岩手県');
INSERT INTO Address(name) VALUES('宮城県');
INSERT INTO Address(name) VALUES('秋田県');
INSERT INTO Address(name) VALUES('山形県');
INSERT INTO Address(name) VALUES('福島県');
INSERT INTO Address(name) VALUES('茨城県');
INSERT INTO Address(name) VALUES('栃木県');
INSERT INTO Address(name) VALUES('群馬県');
INSERT INTO Address(name) VALUES('埼玉県');
INSERT INTO Address(name) VALUES('千葉県');
INSERT INTO Address(name) VALUES('東京都');
INSERT INTO Address(name) VALUES('神奈川県');
INSERT INTO Address(name) VALUES('新潟県');
INSERT INTO Address(name) VALUES('富山県');
INSERT INTO Address(name) VALUES('石川県');
INSERT INTO Address(name) VALUES('福井県');
INSERT INTO Address(name) VALUES('山梨県');
INSERT INTO Address(name) VALUES('長野県');
INSERT INTO Address(name) VALUES('岐阜県');
INSERT INTO Address(name) VALUES('静岡県');
INSERT INTO Address(name) VALUES('愛知県');
INSERT INTO Address(name) VALUES('三重県');
INSERT INTO Address(name) VALUES('滋賀県');
INSERT INTO Address(name) VALUES('京都府');
INSERT INTO Address(name) VALUES('大阪府');
INSERT INTO Address(name) VALUES('兵庫県');
INSERT INTO Address(name) VALUES('奈良県');
INSERT INTO Address(name) VALUES('和歌山県');
INSERT INTO Address(name) VALUES('鳥取県');
INSERT INTO Address(name) VALUES('島根県');
INSERT INTO Address(name) VALUES('岡山県');
INSERT INTO Address(name) VALUES('広島県');
INSERT INTO Address(name) VALUES('山口県');
INSERT INTO Address(name) VALUES('徳島県');
INSERT INTO Address(name) VALUES('香川県');
INSERT INTO Address(name) VALUES('愛媛県');
INSERT INTO Address(name) VALUES('高知県');
INSERT INTO Address(name) VALUES('福岡県');
INSERT INTO Address(name) VALUES('佐賀県');
INSERT INTO Address(name) VALUES('長崎県');
INSERT INTO Address(name) VALUES('熊本県');
INSERT INTO Address(name) VALUES('大分県');
INSERT INTO Address(name) VALUES('宮崎県');
INSERT INTO Address(name) VALUES('鹿児島県');
INSERT INTO Address(name) VALUES('沖縄県');
```

**dotnet efコマンドを再実行する**
> **SQLServerの場合**
> ```sh
> dotnet ef dbcontext scaffold "Server=.;Database=mvcdb;Trusted_Connection=True;TrustServerCertificate=Yes" Microsoft.EntityFrameworkCore.SqlServer -o Models -f
> ```

> **PostgreSQLの場合**
> ```sh
> > dotnet ef dbcontext scaffold "Server=localhost; Port=5432; Database=mvcdb; Username=mvcuser; Password=mvcuser" Npgsql.EntityFrameworkCore.PostgreSQL -o Models -f
> ```
※強制的に上書きをする<font color="blue">「-f」オプション</font>を付ける。

**スキャフォールディング機能を再実行する**

**動作確認**

<br>

#### 4.3 独自のModelクラス
<font color="red">コードファースト</font>：Modelクラスを作ってからデータベースを自動生成する機能

**新しいプロジェクトを作成する**
　　テンプレート　：「ASP.NET Core Web アプリ（Model-View-Controller）」
　　プロジェクト名：「SampleCFModelMvc」

**Personクラスを作成する**
```cs
namespace SampleCFModelMvc.Models;

public class Person
{
    public int Id { get; set; }

    public string Name { get; set; } = null!;

    public int Age { get; set; }
}
```

**NuGetパッケージを追加**
SampleCFModelMvc.csprjファイルへ追加
```xml
  <!-- ■SQL Serverの場合 -->
  <ItemGroup>
    <PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="10.0.3"></PackageReference>
    <PackageReference Include="Microsoft.EntityFrameworkCore.SqlServer" Version="10.0.3" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="10.0.3"></PackageReference>
  </ItemGroup>
```

```xml
  <!-- ■PostgreSQLの場合 -->
  <ItemGroup>
    <PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="10.0.3"></PackageReference>
    <PackageReference Include="Microsoft.EntityFrameworkCore.SqlServer" Version="10.0.3" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="10.0.3"></PackageReference>
    <PackageReference Include="Microsoft.VisualStudio.Web.CodeGeneration.Design" Version="10.0.2" />
    <PackageReference Include="Npgsql.EntityFrameworkCore.PostgreSQL" Version="10.0.0" />
  </ItemGroup>
```

**DbContextクラスを作る**
```cs
using Microsoft.EntityFrameworkCore;

namespace SampleCFModelMvc.Models;

public class MvcdbContext : DbContext
{
    public MvcdbContext()
    {
    }

    public MvcdbContext(DbContextOptions<MvcdbContext> options) : base(options)
    {
    }

    public virtual DbSet<Person> People { get; set; }
}
```

**Program.csファイルを修正する**
```cs
// ■SQL Serverの場合
...略...
// Add services to the container.
builder.Services.AddControllersWithViews();

builder.Services.AddDbContext<MvcdbContext>(
    options => options.UseSqlServer(
        builder.Configuration.GetConnectionString("DefaultConnection")
    )
);
...略...
```

```cs
// ■PostgreSQLの場合
...略...
// Add services to the container.
builder.Services.AddControllersWithViews();

builder.Services.AddDbContext<MvcdbContext>(
    options => options.UseNpgsql(
        builder.Configuration.GetConnectionString("DefaultConnection")
    )
);
...略...
```

**appsettings.jsonに接続文字列を追加する**
```json
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost; Port=5432; Database=mvcdb; Username=mvcuser; Password=mvcuser"
  },
```

**データベースを作成する**
```
dotnet ef migrations add Initial
dotnet ef database update
```

**データベースの削除**
```
dotnet ef database drop
```

**スキャフォールディング機能を実行する**

**動作確認**

<br>

**Addressクラスを作る**
```cs
namespace SampleCFModelMvc.Models;

public class Address
{
    public int Id { get; set; }
    public string Name { get; set; } = null!;
}
```

**Personクラスを修正する**
```cs
namespace SampleCFModelMvc.Models;

public class Person
{
    public int Id { get; set; }

    public string Name { get; set; } = null!;

    public int Age { get; set; }

    // Addressへ外部リンク★
    public int AddressId { get; set; }
    public Address Address { get; set; } = null!;
}
```

**マイグレーションしてデータベースを更新する**
```
dotnet ef migrations add ChangePerson
dotnet ef database update
```

**Addressへデータ挿入**
```sql
INSERT INTO code_first."Address"("Name") VALUES('北海道');
INSERT INTO code_first."Address"("Name") VALUES('青森県');
INSERT INTO code_first."Address"("Name") VALUES('岩手県');
INSERT INTO code_first."Address"("Name") VALUES('宮城県');
INSERT INTO code_first."Address"("Name") VALUES('秋田県');
INSERT INTO code_first."Address"("Name") VALUES('山形県');
INSERT INTO code_first."Address"("Name") VALUES('福島県');
INSERT INTO code_first."Address"("Name") VALUES('茨城県');
INSERT INTO code_first."Address"("Name") VALUES('栃木県');
INSERT INTO code_first."Address"("Name") VALUES('群馬県');
INSERT INTO code_first."Address"("Name") VALUES('埼玉県');
INSERT INTO code_first."Address"("Name") VALUES('千葉県');
INSERT INTO code_first."Address"("Name") VALUES('東京都');
INSERT INTO code_first."Address"("Name") VALUES('神奈川県');
INSERT INTO code_first."Address"("Name") VALUES('新潟県');
INSERT INTO code_first."Address"("Name") VALUES('富山県');
INSERT INTO code_first."Address"("Name") VALUES('石川県');
INSERT INTO code_first."Address"("Name") VALUES('福井県');
INSERT INTO code_first."Address"("Name") VALUES('山梨県');
INSERT INTO code_first."Address"("Name") VALUES('長野県');
INSERT INTO code_first."Address"("Name") VALUES('岐阜県');
INSERT INTO code_first."Address"("Name") VALUES('静岡県');
INSERT INTO code_first."Address"("Name") VALUES('愛知県');
INSERT INTO code_first."Address"("Name") VALUES('三重県');
INSERT INTO code_first."Address"("Name") VALUES('滋賀県');
INSERT INTO code_first."Address"("Name") VALUES('京都府');
INSERT INTO code_first."Address"("Name") VALUES('大阪府');
INSERT INTO code_first."Address"("Name") VALUES('兵庫県');
INSERT INTO code_first."Address"("Name") VALUES('奈良県');
INSERT INTO code_first."Address"("Name") VALUES('和歌山県');
INSERT INTO code_first."Address"("Name") VALUES('鳥取県');
INSERT INTO code_first."Address"("Name") VALUES('島根県');
INSERT INTO code_first."Address"("Name") VALUES('岡山県');
INSERT INTO code_first."Address"("Name") VALUES('広島県');
INSERT INTO code_first."Address"("Name") VALUES('山口県');
INSERT INTO code_first."Address"("Name") VALUES('徳島県');
INSERT INTO code_first."Address"("Name") VALUES('香川県');
INSERT INTO code_first."Address"("Name") VALUES('愛媛県');
INSERT INTO code_first."Address"("Name") VALUES('高知県');
INSERT INTO code_first."Address"("Name") VALUES('福岡県');
INSERT INTO code_first."Address"("Name") VALUES('佐賀県');
INSERT INTO code_first."Address"("Name") VALUES('長崎県');
INSERT INTO code_first."Address"("Name") VALUES('熊本県');
INSERT INTO code_first."Address"("Name") VALUES('大分県');
INSERT INTO code_first."Address"("Name") VALUES('宮崎県');
INSERT INTO code_first."Address"("Name") VALUES('鹿児島県');
INSERT INTO code_first."Address"("Name") VALUES('沖縄県');
```

**スキャフォールディング機能を再実行する**

